---
layout: post
title: "Cilium ë„¤íŠ¸ì›Œí‚¹ í•¸ì¦ˆì˜¨ ê°€ì´ë“œ (6): Security & Tetragon"
date: 2025-09-01 10:00:00 +0900
categories: cilium security
tags: [cilium, security, tetragon, ebpf, network-policy, encryption, wireguard, tls-inspection, identity, kubernetes]
---

## Cilium ë„¤íŠ¸ì›Œí‚¹ í•¸ì¦ˆì˜¨ ê°€ì´ë“œ (6)

Ciliumì˜ ê°•ë ¥í•œ ë³´ì•ˆ ê¸°ëŠ¥ê³¼ Tetragonì„ í™œìš©í•œ ëŸ°íƒ€ì„ ë³´ì•ˆ ëª¨ë‹ˆí„°ë§ì„ ì‹¤ìŠµì„ í†µí•´ ì•Œì•„ë´…ë‹ˆë‹¤.  
ì´ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œëŠ” Identity ê¸°ë°˜ ë³´ì•ˆ, ë„¤íŠ¸ì›Œí¬ ì •ì±…, Wireguard ì•”í˜¸í™”, TLS ê²€ì‚¬, ê·¸ë¦¬ê³  Tetragonì„ í†µí•œ ì‹¤ì‹œê°„ ìœ„í˜‘ íƒì§€ë¥¼ ë‹¤ë£¹ë‹ˆë‹¤.  
ì¶”ê°€ì ìœ¼ë¡œ Ciliumì´ ì œê³µí•˜ëŠ” L3-L7 ì œì–´ë¥¼ ë‹´ë‹¹í•˜ëŠ” CRDë¥¼ ì•Œì•„ë³´ê³  L3 ì œì–´ë¥¼ í•¸ì¦ˆì˜¨ í•©ë‹ˆë‹¤.

### ì‹¤ìŠµ í™˜ê²½ ì†Œê°œ

K8S 1.33.4, Cilium 1.18.1 í™˜ê²½ì—ì„œ ë³´ì•ˆ ê¸°ëŠ¥ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.

- Control Plane(k8s-ctr): 192.168.10.100
- Worker Node 1(k8s-w1): 192.168.10.101
- Worker Node 2(k8s-w2): 192.168.10.102

---

## Cilium Security ê°œìš”

### Identity ê¸°ë°˜ ë³´ì•ˆ

Ciliumì€ ëª¨ë“  ì—”ë“œí¬ì¸íŠ¸ì— ê³ ìœ í•œ Identityë¥¼ í• ë‹¹í•˜ì—¬ ë³´ì•ˆì„ êµ¬í˜„í•©ë‹ˆë‹¤.

```bash
# Identity í™•ì¸
kubectl get ciliumendpoints.cilium.io -n kube-system

# NAME                              SECURITY IDENTITY   ENDPOINT STATE   IPV4           IPV6
# coredns-674b8bbfcf-75xst          22940               ready            172.20.0.88    
# coredns-674b8bbfcf-9drgd          22940               ready            172.20.0.42    
# hubble-relay-fdd49b976-tgqnw      28238               ready            172.20.0.145   
# hubble-ui-655f947f96-qvpzs        736                 ready            172.20.0.220   
# metrics-server-5dd7b49d79-vcxc2   21387               ready            172.20.0.98   

kubectl get ciliumidentities.cilium.io

# NAME    NAMESPACE            AGE
# 11108   cilium-monitoring    12m
# 21387   kube-system          12m
# 22940   kube-system          12m
# 28238   kube-system          12m
# 4035    cilium-monitoring    12m
# 5257    local-path-storage   12m
# 736     kube-system          12m

# íŠ¹ì • Identity ìƒì„¸ ì •ë³´
kubectl exec -it -n kube-system ds/cilium -- cilium identity list

# ...
# 736     k8s:app.kubernetes.io/name=hubble-ui
#         k8s:app.kubernetes.io/part-of=cilium
#         k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system
#         k8s:io.cilium.k8s.policy.cluster=default
#         k8s:io.cilium.k8s.policy.serviceaccount=hubble-ui
#         k8s:io.kubernetes.pod.namespace=kube-system
#         k8s:k8s-app=hubble-ui
# ...
```

IdentityëŠ” ë‹¤ìŒê³¼ ê°™ì€ íŠ¹ì„±ì„ ê°€ì§‘ë‹ˆë‹¤.
- Labels ê¸°ë°˜ìœ¼ë¡œ ìë™ ìƒì„±
- í´ëŸ¬ìŠ¤í„° ì „ì²´ì—ì„œ ìœ ì¼í•œ ID
- ë™ì¼í•œ Security Labelsë¥¼ ê°€ì§„ ì—”ë“œí¬ì¸íŠ¸ëŠ” ë™ì¼í•œ ID ê³µìœ 

### Special Identities

Ciliumì€ íŠ¹ìˆ˜í•œ ëª©ì ì˜ ì˜ˆì•½ëœ Identityë“¤ì„ ì œê³µí•©ë‹ˆë‹¤.

```bash
kubectl exec -it -n kube-system ds/cilium -- cilium identity list

# 1       reserved:host
#         reserved:kube-apiserver
# 2       reserved:world
# 3       reserved:unmanaged
# 4       reserved:health
# 5       reserved:init
# 6       reserved:remote-node
# 7       reserved:kube-apiserver
#         reserved:remote-node
# 8       reserved:ingress
```

| Identity                | ID  | ì„¤ëª… |
|-------------------------|-----|------|
| reserved:unknown        | 0   | Identityë¥¼ íŒŒìƒí•  ìˆ˜ ì—†ì„ ë•Œ í• ë‹¹ë˜ëŠ” ê°’ì…ë‹ˆë‹¤. |
| reserved:host           | 1   | ë¡œì»¬ í˜¸ìŠ¤íŠ¸. ë¡œì»¬ í˜¸ìŠ¤íŠ¸ IPì—ì„œ ë°œìƒí•˜ê±°ë‚˜ ë¡œì»¬ í˜¸ìŠ¤íŠ¸ë¡œ ì§€ì •ëœ íŠ¸ë˜í”½ì— ì‚¬ìš©ë©ë‹ˆë‹¤. |
| reserved:world          | 2   | í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ì˜ ëª¨ë“  ë„¤íŠ¸ì›Œí¬ ì—”ë“œí¬ì¸íŠ¸. |
| reserved:unmanaged      | 3   | Ciliumì´ ê´€ë¦¬í•˜ì§€ ì•ŠëŠ” ì—”ë“œí¬ì¸íŠ¸(ì˜ˆ: Cilium ì„¤ì¹˜ ì „ ìƒì„±ëœ Pod ë“±). |
| reserved:health         | 4   | Cilium ì—ì´ì „íŠ¸ê°€ ìƒì„±í•˜ëŠ” í—¬ìŠ¤ ì²´í¬ íŠ¸ë˜í”½. |
| reserved:init           | 5   | Identityê°€ ì•„ì§ í• ë‹¹ë˜ì§€ ì•Šì€ ì—”ë“œí¬ì¸íŠ¸(ë¶€íŠ¸ìŠ¤íŠ¸ë© ë‹¨ê³„ ë“±, ë©”íƒ€ë°ì´í„°ê°€ ë¶€ì¡±í•œ ê²½ìš°). Docker í”ŒëŸ¬ê·¸ì¸ ë“±ì—ì„œ ì—”ë“œí¬ì¸íŠ¸ ìƒì„± ì‹œ ë ˆì´ë¸”ì„ ì•Œ ìˆ˜ ì—†ì„ ë•Œ í• ë‹¹ë©ë‹ˆë‹¤. |
| reserved:remote-node    | 6   | ëª¨ë“  ì›ê²© í´ëŸ¬ìŠ¤í„° í˜¸ìŠ¤íŠ¸ì˜ ì§‘í•©. ë¡œì»¬ ë…¸ë“œê°€ ì•„ë‹Œ ë‹¤ë¥¸ í´ëŸ¬ìŠ¤í„°ì˜ í˜¸ìŠ¤íŠ¸ IPì—ì„œ ë°œìƒí•˜ê±°ë‚˜ í•´ë‹¹ IPë¡œ ì§€ì •ëœ íŠ¸ë˜í”½ì— ì‚¬ìš©ë©ë‹ˆë‹¤. |
| reserved:kube-apiserver | 7   | kube-apiserverë¥¼ ë°±ì—”ë“œë¡œ ì‚¬ìš©í•˜ëŠ” ì›ê²© ë…¸ë“œ(ë“¤). |
| reserved:ingress        | 8   | Ingress í”„ë¡ì‹œì—ì„œ ë°œìƒí•˜ëŠ” ì—°ê²°ì˜ ì†ŒìŠ¤ IPì— í• ë‹¹ë©ë‹ˆë‹¤. |

---

## ë„¤íŠ¸ì›Œí¬ ì •ì±… (Network Policy)

### 3ê°€ì§€ ì •ì±… í˜•ì‹

1. **NetworkPolicy**: í‘œì¤€ K8S NetworkPolicy
2. **CiliumNetworkPolicy**: L3-L7 ì •ì±… ì§€ì›
3. **CiliumClusterwideNetworkPolicy**: í´ëŸ¬ìŠ¤í„° ì „ì²´ ì •ì±…

### Layer 3 ì •ì±…

Layer 3 ì •ì±…ì€ IP ì£¼ì†Œë‚˜ ì—”ë“œí¬ì¸íŠ¸ ë ˆì´ë¸”ì„ ê¸°ë°˜ìœ¼ë¡œ íŠ¸ë˜í”½ì„ ì œì–´í•©ë‹ˆë‹¤. ë‹¤ì–‘í•œ ë°©ì‹ìœ¼ë¡œ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.  

#### ì—”ë“œí¬ì¸íŠ¸ ê¸°ë°˜ ì •ì±… (Endpoints-based)

ë‘ ì—”ë“œí¬ì¸íŠ¸ê°€ Ciliumì— ì˜í•´ ê´€ë¦¬ë˜ê³  ë ˆì´ë¸”ì´ í• ë‹¹ëœ ê²½ìš° ì‚¬ìš©í•©ë‹ˆë‹¤.

**ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬**

```bash
# Frontend Pod ë°°í¬
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: frontend
  labels:
    role: frontend
spec:
  containers:
  - name: nginx
    image: nginx:alpine
    ports:
    - containerPort: 80
EOF

# Backend Pod ë°°í¬
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: backend
  labels:
    role: backend
spec:
  containers:
  - name: nginx
    image: nginx:alpine
    ports:
    - containerPort: 80
EOF

# í…ŒìŠ¤íŠ¸ìš© í´ë¼ì´ì–¸íŠ¸ Pod ë°°í¬
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: client
  labels:
    role: client
spec:
  containers:
  - name: curl
    image: nicolaka/netshoot
    command: ["tail", "-f", "/dev/null"]
EOF
```

**ì •ì±… ì ìš© ì „ í…ŒìŠ¤íŠ¸**

```bash
# Backend Podì˜ IP í™•ì¸
BACKEND_IP=$(kubectl get pod backend -o jsonpath='{.status.podIP}')
echo "Backend IP: $BACKEND_IP"

# Frontendì—ì„œ Backendë¡œ ì ‘ê·¼ (ì„±ê³µ)
kubectl exec frontend -- curl -s --connect-timeout 2 $BACKEND_IP

# Clientì—ì„œ Backendë¡œ ì ‘ê·¼ (ì„±ê³µ)
kubectl exec client -- curl -s --connect-timeout 2 $BACKEND_IP

# <!DOCTYPE html>
# <html>
# <head>
# <title>Welcome to nginx!</title>
# <style>
# html { color-scheme: light dark; }
# body { width: 35em; margin: 0 auto;
# font-family: Tahoma, Verdana, Arial, sans-serif; }
# </style>
# </head>
# <body>
# <h1>Welcome to nginx!</h1>
# <p>If you see this page, the nginx web server is successfully installed and
# working. Further configuration is required.</p>

# <p>For online documentation and support please refer to
# <a href="http://nginx.org/">nginx.org</a>.<br/>
# Commercial support is available at
# <a href="http://nginx.com/">nginx.com</a>.</p>

# <p><em>Thank you for using nginx.</em></p>
# </body>
# </html>
```

**ì—”ë“œí¬ì¸íŠ¸ ê¸°ë°˜ ì •ì±… ì ìš©**

```yaml
cat <<EOF | kubectl apply -f -
apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: "l3-endpoints-rule"
spec:
  endpointSelector:
    matchLabels:
      role: backend
  ingress:
  - fromEndpoints:
    - matchLabels:
        role: frontend
EOF
```

**ì •ì±… ì ìš© í›„ í…ŒìŠ¤íŠ¸**

```bash
# Frontendì—ì„œ Backendë¡œ ì ‘ê·¼ (ì„±ê³µ)
kubectl exec frontend -- curl -s --connect-timeout 2 $BACKEND_IP

# Clientì—ì„œ Backendë¡œ ì ‘ê·¼ (ì‹¤íŒ¨ - íƒ€ì„ì•„ì›ƒ)
kubectl exec client -- curl -s --connect-timeout 2 $BACKEND_IP

# Hubbleë¡œ íŠ¸ë˜í”½ í™•ì¸
cilium hubble port-forward&
hubble observe --pod backend

# ì ‘ê·¼ì œì–´, DROPPED
# Sep  6 15:12:46.890: default/client:55010 (ID:16200) <> default/backend:80 (ID:49668) policy-verdict:none INGRESS DENIED (TCP Flags: SYN)
# Sep  6 15:12:46.890: default/client:55010 (ID:16200) <> default/backend:80 (ID:49668) Policy denied DROPPED (TCP Flags: SYN)
# Sep  6 15:12:47.943: default/client:55010 (ID:16200) <> default/backend:80 (ID:49668) policy-verdict:none INGRESS DENIED (TCP Flags: SYN)
# Sep  6 15:12:47.943: default/client:55010 (ID:16200) <> default/backend:80 (ID:49668) Policy denied DROPPED (TCP Flags: SYN)

# ì •ì±… ì‚­ì œ
kubectl delete CiliumNetworkPolicy l3-endpoints-rule
```

#### ì„œë¹„ìŠ¤ ê¸°ë°˜ ì •ì±… (Services-based)

**Kubernetes ì„œë¹„ìŠ¤ë¥¼ í™œìš©í•œ ì •ì±… êµ¬ì„±**

```bash
# Backend Service ìƒì„±
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Service
metadata:
  name: backend-service
  labels:
    app: backend
spec:
  selector:
    role: backend
  ports:
  - port: 80
    targetPort: 80
EOF

# ì„œë¹„ìŠ¤ ê¸°ë°˜ ì •ì±…
cat <<EOF | kubectl apply -f -
apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: "l3-service-rule"
spec:
  endpointSelector:
    matchLabels:
      role: frontend
  egress:
  - toServices:
    - k8sService:
        serviceName: backend-service
        namespace: default
EOF

# Backend Svcì˜ IP í™•ì¸
BACKEND_IP=$(kubectl get svc backend-service -o jsonpath='{.spec.clusterIP}')
echo "Backend IP: $BACKEND_IP"

# Client Podì˜ IP í™•ì¸
CLIENT_IP=$(kubectl get pod client -o jsonpath='{.status.podIP}')
echo "Client IP: $CLIENT_IP"

# Frontendì—ì„œ Backendë¡œ ì ‘ê·¼ (ì„±ê³µ)
kubectl exec frontend -- curl -s --connect-timeout 2 $BACKEND_IP

# Frontendì—ì„œ Clientë¡œ ì ‘ê·¼ (ì‹¤íŒ¨ - íƒ€ì„ì•„ì›ƒ)
kubectl exec frontend -- curl -s --connect-timeout 2 $CLIENT_IP

# Hubbleë¡œ íŠ¸ë˜í”½ í™•ì¸
hubble observe --pod frontend

# EGRESS ì†¡ì‹  ì¸¡ DENIED
# Sep  6 15:21:33.556: default/frontend:39402 (ID:4296) <> default/client:80 (ID:16200) policy-verdict:none EGRESS DENIED (TCP Flags: SYN)
# Sep  6 15:21:33.556: default/frontend:39402 (ID:4296) <> default/client:80 (ID:16200) Policy denied DROPPED (TCP Flags: SYN)
# Sep  6 15:21:34.611: default/frontend:39402 (ID:4296) <> default/client:80 (ID:16200) policy-verdict:none EGRESS DENIED (TCP Flags: SYN)
# Sep  6 15:21:34.611: default/frontend:39402 (ID:4296) <> default/client:80 (ID:16200) Policy denied DROPPED (TCP Flags: SYN)
```

#### ì—”í‹°í‹° ê¸°ë°˜ ì •ì±… (Entities-based)

**íŠ¹ë³„í•œ ì—”í‹°í‹°(host, world, kube-apiserver ë“±)ì— ëŒ€í•œ ì ‘ê·¼ ì œì–´**

```yaml
cat <<EOF | kubectl apply -f -
apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: "l3-entity-rule"
spec:
  endpointSelector:
    matchLabels:
      role: frontend
  egress:
    # kube-apiserver ì ‘ê·¼ í—ˆìš©
    - toEntities:
      - kube-apiserver
    # í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ ì ‘ê·¼ í—ˆìš©
    - toEntities:
      - world
EOF
```

#### ë…¸ë“œ ê¸°ë°˜ ì •ì±… (Node-based)

`fromNodes`/`toNodes` ì •ì±…ì€ **ë…¸ë“œì˜ í˜¸ìŠ¤íŠ¸ ë„¤íŠ¸ì›Œí¬**ì—ì„œ ì˜¤ëŠ” íŠ¸ë˜í”½ì„ ì œì–´í•©ë‹ˆë‹¤.  
ì¼ë°˜ Pod íŠ¸ë˜í”½ì´ ì•„ë‹Œ ë…¸ë“œ ìì²´ ë˜ëŠ” `hostNetwork: true`ì¸ Podì˜ íŠ¸ë˜í”½ë§Œ ë§¤ì¹­ë©ë‹ˆë‹¤.

**ì¤‘ìš”**: `fromNodes`/`toNodes` ì‚¬ìš© ì‹œ `enable-node-selector-labels` í”Œë˜ê·¸ë¥¼ í™œì„±í™”í•´ì•¼ í•©ë‹ˆë‹¤.

```bash
# Cilium ë…¸ë“œ ê¸°ë°˜ ì •ì±…ì„ ìœ„í•œ í”Œë˜ê·¸ í™œì„±í™”
helm upgrade cilium cilium/cilium --version 1.18.1 --namespace kube-system --reuse-values \
  --set nodeSelectorLabels=true

kubectl rollout restart deploy cilium-operator -n kube-system
kubectl rollout restart ds cilium -n kube-system

# ì„¤ì • í™•ì¸
cilium config view | grep enable-node-selector-labels

# enable-node-selector-labels                       true

# ê° ë…¸ë“œì— í…ŒìŠ¤íŠ¸ìš© ë ˆì´ë¸” ì¶”ê°€
kubectl label node k8s-w1 test-node=worker1
kubectl label node k8s-w2 test-node=worker2

# Control Plane ë…¸ë“œì— Pod ë°°í¬   k
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: control-client
  labels:
    role: control-client
spec:
  nodeSelector:
    node-role.kubernetes.io/control-plane: ""
  tolerations:
  - key: node-role.kubernetes.io/control-plane
    operator: Exists
    effect: NoSchedule
  containers:
  - name: curl
    image: nicolaka/netshoot
    command: ["tail", "-f", "/dev/null"]
EOF

# Worker1 ë…¸ë“œì— Client ë°°í¬
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: worker-client
  labels:
    role: worker-client
spec:
  nodeSelector:
    test-node: worker1
  containers:
  - name: curl
    image: nicolaka/netshoot
    command: ["tail", "-f", "/dev/null"]
EOF

# Worker2 ë…¸ë“œì— Backend ë°°í¬
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: backend
  labels:
    role: backend
spec:
  nodeSelector:
    test-node: worker2
  containers:
  - name: nginx
    image: nginx:alpine
    ports:
    - containerPort: 80
EOF
```

**ì •ì±… ì ìš© ì „ í…ŒìŠ¤íŠ¸**

```bash
# Pod ë°°í¬ í™•ì¸
kubectl get pods -o wide

# NAME             READY   STATUS    RESTARTS   AGE   IP             NODE      NOMINATED NODE   READINESS GATES
# backend          1/1     Running   0          6s    172.20.2.57    k8s-w2    <none>           <none>
# control-client   1/1     Running   0          7s    172.20.0.142   k8s-ctr   <none>           <none>
# worker-client    1/1     Running   0          7s    172.20.1.90    k8s-w1    <none>           <none>

# Backend IP í™•ì¸
BACKEND_IP=$(kubectl get pod backend -o jsonpath='{.status.podIP}')
echo "Backend IP: $BACKEND_IP"

# Control Plane ë…¸ë“œì—ì„œ Backend ì ‘ê·¼ (ì„±ê³µ)
kubectl exec control-client -- curl -s --connect-timeout 2 $BACKEND_IP | head -5

# Worker ë…¸ë“œì—ì„œ Backend ì ‘ê·¼ (ì„±ê³µ)
kubectl exec worker-client -- curl -s --connect-timeout 2 $BACKEND_IP | head -5

# <!DOCTYPE html>
# <html>
# <head>
# <title>Welcome to nginx!</title>
# <style>
```

**ë…¸ë“œ ê¸°ë°˜ ì •ì±… ì ìš©**

```bash
# Control Plane ë…¸ë“œì—ì„œë§Œ ì ‘ê·¼ í—ˆìš©í•˜ëŠ” ì •ì±…
cat <<EOF | kubectl apply -f -
apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: "l3-node-rule"
spec:
  endpointSelector:
    matchLabels:
      role: backend
  ingress:
    - fromNodes:
        - matchLabels:
            node-role.kubernetes.io/control-plane: ""
EOF
```

**ì •ì±… ì ìš© í›„ í…ŒìŠ¤íŠ¸**

```bash
# ì¼ë°˜ Podì—ì„œëŠ” ëª¨ë‘ ì°¨ë‹¨ë¨ (fromNodesëŠ” Pod íŠ¸ë˜í”½ê³¼ ë§¤ì¹­ë˜ì§€ ì•ŠìŒ)
kubectl exec control-client -- curl -s --connect-timeout 2 $BACKEND_IP  # ì‹¤íŒ¨
kubectl exec worker-client -- curl -s --connect-timeout 2 $BACKEND_IP   # ì‹¤íŒ¨

# Hubbleë¡œ íŠ¸ë˜í”½ ëª¨ë‹ˆí„°ë§
hubble observe --pod backend

# Sep  6 16:20:47.070: default/control-client:51012 (ID:53530) <> default/backend:80 (ID:49668) policy-verdict:none INGRESS DENIED (TCP Flags: SYN)
# Sep  6 16:20:47.070: default/control-client:51012 (ID:53530) <> default/backend:80 (ID:49668) Policy denied DROPPED (TCP Flags: SYN)
# Sep  6 16:20:48.129: default/control-client:51012 (ID:53530) <> default/backend:80 (ID:49668) policy-verdict:none INGRESS DENIED (TCP Flags: SYN)
# Sep  6 16:20:48.129: default/control-client:51012 (ID:53530) <> default/backend:80 (ID:49668) Policy denied DROPPED (TCP Flags: SYN)
# Sep  6 16:20:49.267: default/worker-client:45220 (ID:17873) <> default/backend:80 (ID:49668) policy-verdict:none INGRESS DENIED (TCP Flags: SYN)
# Sep  6 16:20:49.267: default/worker-client:45220 (ID:17873) <> default/backend:80 (ID:49668) Policy denied DROPPED (TCP Flags: SYN)
# Sep  6 16:20:50.311: default/worker-client:45220 (ID:17873) <> default/backend:80 (ID:49668) policy-verdict:none INGRESS DENIED (TCP Flags: SYN)
# Sep  6 16:20:50.311: default/worker-client:45220 (ID:17873) <> default/backend:80 (ID:49668) Policy denied DROPPED (TCP Flags: SYN)

# Host Network Pod ìƒì„± (Control Plane)
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: host-control
spec:
  hostNetwork: true  # ì¤‘ìš”!
  nodeSelector:
    node-role.kubernetes.io/control-plane: ""
  tolerations:
  - key: node-role.kubernetes.io/control-plane
    operator: Exists
    effect: NoSchedule
  containers:
  - name: curl
    image: nicolaka/netshoot
    command: ["tail", "-f", "/dev/null"]
EOF

# Host Network Podì—ì„œ í…ŒìŠ¤íŠ¸ (ì„±ê³µ!)
kubectl exec host-control -- curl -s --connect-timeout 2 $BACKEND_IP | head -5

# Sep  6 16:21:20.309: 192.168.10.100:53232 (ID:33554433) -> default/backend:80 (ID:49668) policy-verdict:L3-Only INGRESS ALLOWED (TCP Flags: SYN)
# Sep  6 16:21:20.309: 192.168.10.100:53232 (ID:33554433) -> default/backend:80 (ID:49668) to-endpoint FORWARDED (TCP Flags: SYN)
# Sep  6 16:21:20.309: 192.168.10.100:53232 (ID:33554433) <- default/backend:80 (ID:49668) to-network FORWARDED (TCP Flags: SYN, ACK)
# Sep  6 16:21:20.310: 192.168.10.100:53232 (ID:33554433) -> default/backend:80 (ID:49668) to-endpoint FORWARDED (TCP Flags: ACK)
# Sep  6 16:21:20.311: 192.168.10.100:53232 (ID:33554433) <> default/backend (ID:49668) pre-xlate-rev TRACED (TCP)
# Sep  6 16:21:20.315: 192.168.10.100:53232 (ID:33554433) -> default/backend:80 (ID:49668) to-endpoint FORWARDED (TCP Flags: ACK, PSH)
# Sep  6 16:21:20.317: 192.168.10.100:53232 (ID:33554433) <> default/backend (ID:49668) pre-xlate-rev TRACED (TCP)
# Sep  6 16:21:20.317: 192.168.10.100:53232 (ID:33554433) <> default/backend (ID:49668) pre-xlate-rev TRACED (TCP)
# Sep  6 16:21:20.317: 192.168.10.100:53232 (ID:33554433) <- default/backend:80 (ID:49668) to-network FORWARDED (TCP Flags: ACK, PSH)
# Sep  6 16:21:20.319: 192.168.10.100:53232 (host) -> default/backend:80 (ID:49668) to-network FORWARDED (TCP Flags: SYN)
# Sep  6 16:21:20.320: 192.168.10.100:53232 (ID:33554433) -> default/backend:80 (ID:49668) to-endpoint FORWARDED (TCP Flags: ACK, FIN)
# Sep  6 16:21:20.321: 192.168.10.100:53232 (host) -> default/backend:80 (ID:49668) to-network FORWARDED (TCP Flags: ACK)
# Sep  6 16:21:20.322: 192.168.10.100:53232 (ID:33554433) <- default/backend:80 (ID:49668) to-network FORWARDED (TCP Flags: ACK, FIN)
# Sep  6 16:21:20.324: 192.168.10.100:53232 (host) -> default/backend:80 (ID:49668) to-network FORWARDED (TCP Flags: ACK, PSH)
# Sep  6 16:21:20.324: 192.168.10.100:53232 (ID:33554433) -> default/backend:80 (ID:49668) to-endpoint FORWARDED (TCP Flags: ACK)
# Sep  6 16:21:20.331: 192.168.10.100:53232 (host) -> default/backend:80 (ID:49668) to-network FORWARDED (TCP Flags: ACK, FIN)

# Worker ë…¸ë“œì˜ Host Network Pod ìƒì„±
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: host-worker
spec:
  hostNetwork: true
  nodeSelector:
    test-node: worker1
  containers:
  - name: curl
    image: nicolaka/netshoot
    command: ["tail", "-f", "/dev/null"]
EOF

# Workerì˜ Host Network Podì—ì„œ í…ŒìŠ¤íŠ¸ (ì‹¤íŒ¨!)
kubectl exec host-worker -- curl -s --connect-timeout 2 $BACKEND_IP

# Sep  6 16:21:54.491: 192.168.10.101:37488 (ID:33554434) <> default/backend:80 (ID:49668) policy-verdict:none INGRESS DENIED (TCP Flags: SYN)
# Sep  6 16:21:54.491: 192.168.10.101:37488 (ID:33554434) <> default/backend:80 (ID:49668) Policy denied DROPPED (TCP Flags: SYN)
# Sep  6 16:21:54.491: 192.168.10.101:37488 (host) -> default/backend:80 (ID:49668) to-network FORWARDED (TCP Flags: SYN)
# Sep  6 16:21:55.526: 192.168.10.101:37488 (ID:33554434) <> default/backend:80 (ID:49668) policy-verdict:none INGRESS DENIED (TCP Flags: SYN)
# Sep  6 16:21:55.526: 192.168.10.101:37488 (ID:33554434) <> default/backend:80 (ID:49668) Policy denied DROPPED (TCP Flags: SYN)
```

#### CIDR ê¸°ë°˜ ì •ì±… (IP/CIDR-based)

**íŠ¹ì • IP ëŒ€ì—­ ì œì–´**

```yaml
cat <<EOF | kubectl apply -f -
apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: "l3-cidr-rule"
spec:
  endpointSelector:
    matchLabels:
      role: frontend
  egress:
  # íŠ¹ì • IPë§Œ í—ˆìš©
  - toCIDR:
    - 20.1.1.1/32
  # íŠ¹ì • ëŒ€ì—­ í—ˆìš©, ì¼ë¶€ ì œì™¸
  - toCIDRSet:
    - cidr: 10.0.0.0/8
      except:
      - 10.96.0.0/12
EOF
```

#### DNS ê¸°ë°˜ ì •ì±… (DNS-based)

**ë„ë©”ì¸ ì´ë¦„ ê¸°ë°˜ íŠ¸ë˜í”½ ì œì–´**

```yaml
cat <<EOF | kubectl apply -f -
apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: "l3-dns-rule"
spec:
  endpointSelector:
    matchLabels:
      role: frontend
  egress:
  # DNS ì¿¼ë¦¬ í—ˆìš©
  - toEndpoints:
    - matchLabels:
        "k8s:io.kubernetes.pod.namespace": kube-system
        "k8s:k8s-app": kube-dns
    toPorts:
    - ports:
      - port: "53"
        protocol: ANY
      rules:
        dns:
        - matchPattern: "*"
  # íŠ¹ì • ë„ë©”ì¸ ì ‘ê·¼ í—ˆìš©
  - toFQDNs:
    - matchName: "example.com"
    - matchPattern: "*.example.com"
EOF
```

---

## DNS ê¸°ë°˜ ë³´ì•ˆ ì •ì±…

### ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬

```bash
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: mediabot
  labels:
    org: empire
    class: mediabot
    app: mediabot
spec:
  containers:
  - name: mediabot
    image: quay.io/cilium/json-mock:v1.3.8@sha256:5aad04835eda9025fe4561ad31be77fd55309af8158ca8663a72f6abb78c2603
EOF

kubectl wait pod/mediabot --for=condition=Ready
```

### DNS Egress ì •ì±… ì ìš©

**íŠ¹ì • ë„ë©”ì¸ë§Œ í—ˆìš©í•˜ëŠ” ì •ì±…**

```bash
# ì •ì±… ì ìš©
cat <<EOF | kubectl apply -f -
apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: "fqdn"
spec:
  endpointSelector:
    matchLabels:
      org: empire
      class: mediabot
  egress:
  - toFQDNs:
    - matchName: "api.github.com"
  - toEndpoints:
    - matchLabels:
        "k8s:io.kubernetes.pod.namespace": kube-system
        "k8s:k8s-app": kube-dns
    toPorts:
    - ports:
      - port: "53"
        protocol: ANY
      rules:
        dns:
        - matchPattern: "*"
EOF

# í…ŒìŠ¤íŠ¸
kubectl exec mediabot -- curl -I -s https://api.github.com | head -1  # ì„±ê³µ

# Sep  6 16:30:32.324: default/mediabot (ID:27702) <> kube-system/coredns-674b8bbfcf-75xst:53 (ID:22940) post-xlate-fwd TRANSLATED (UDP)
# Sep  6 16:30:32.325: default/mediabot:52632 (ID:27702) -> kube-system/coredns-674b8bbfcf-75xst:53 (ID:22940) policy-verdict:L3-L4 EGRESS ALLOWED (UDP)

kubectl exec mediabot -- curl -I -s --max-time 5 https://support.github.com | head -1  # ì‹¤íŒ¨

# Sep  6 16:31:07.007: default/mediabot:58898 (ID:27702) <> support.github.com:443 (world) policy-verdict:none EGRESS DENIED (TCP Flags: SYN)

hubble observe --pod mediabot

```

---

## WireGuard ì•”í˜¸í™”

### WireGuard ì„¤ì •

```bash
# ì»¤ë„ ëª¨ë“ˆ í™•ì¸
grep -E 'CONFIG_WIREGUARD=m' /boot/config-$(uname -r)

# WireGuard í™œì„±í™”
helm upgrade cilium cilium/cilium --version 1.18.1 --namespace kube-system --reuse-values \
  --set encryption.enabled=true --set encryption.type=wireguard

kubectl rollout restart deploy cilium-operator -n kube-system
kubectl rollout restart ds cilium -n kube-system

# ìƒíƒœ í™•ì¸
kubectl exec -it -n kube-system ds/cilium -- cilium encrypt status

# Encryption: Wireguard                 
# Interface: cilium_wg0
# 	Public key: ASDBXvsj1FO8/i616o9jnaLtlxr40pp3CGw7WPNO+zg=
# 	Number of peers: 2
```

### ì•”í˜¸í™” í™•ì¸

```bash
# WireGuard ì¸í„°í˜ì´ìŠ¤ í™•ì¸
wg show

# interface: cilium_wg0
#   public key: vKot76km/vkpVAaI62tSgdQKQnIpW3jjh98FjMBwIig=
#   private key: (hidden)
#   listening port: 51871
#   fwmark: 0xe00

# peer: ASDBXvsj1FO8/i616o9jnaLtlxr40pp3CGw7WPNO+zg=
#   endpoint: 192.168.10.102:51871
#   allowed ips: 192.168.10.102/32, 172.20.2.174/32, 172.20.2.161/32, 172.20.2.0/24

# peer: cZlq7o9YqdgqRQEthadT3RQppEtVsN8sEn1uEf0jsV4=
#   endpoint: 192.168.10.101:51871
#   allowed ips: 172.20.1.141/32, 172.20.1.0/24, 172.20.1.183/32, 192.168.10.101/32

ip -d -c addr show cilium_wg0


# ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬
cat << EOF | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webpod
spec:
  replicas: 2
  selector:
    matchLabels:
      app: webpod
  template:
    metadata:
      labels:
        app: webpod
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - sample-app
            topologyKey: "kubernetes.io/hostname"
      containers:
      - name: webpod
        image: traefik/whoami
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: webpod
  labels:
    app: webpod
spec:
  selector:
    app: webpod
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
  type: ClusterIP
EOF


# k8s-ctr ë…¸ë“œì— curl-pod íŒŒë“œ ë°°í¬
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: curl-pod
  labels:
    app: curl
spec:
  nodeName: k8s-ctr
  containers:
  - name: curl
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
EOF

# ì•”í˜¸í™”ëœ íŠ¸ë˜í”½ ìº¡ì²˜
kubectl exec -it curl-pod -- curl webpod
tcpdump -eni any udp port 51871

# 01:42:43.610384 eth1  Out ifindex 3 08:00:27:41:69:da ethertype IPv4 (0x0800), length 144: 192.168.10.100.51871 > 192.168.10.102.51871: UDP, length 96
# 01:42:43.612326 eth1  In  ifindex 3 08:00:27:6f:81:26 ethertype IPv4 (0x0800), length 144: 192.168.10.102.51871 > 192.168.10.100.51871: UDP, length 96
# 01:42:43.614541 eth1  Out ifindex 3 08:00:27:41:69:da ethertype IPv4 (0x0800), length 144: 192.168.10.100.51871 > 192.168.10.102.51871: UDP, length 96
# 01:42:43.614812 eth1  Out ifindex 3 08:00:27:41:69:da ethertype IPv4 (0x0800), length 208: 192.168.10.100.51871 > 192.168.10.102.51871: UDP, length 160
# 01:42:43.618541 eth1  In  ifindex 3 08:00:27:6f:81:26 ethertype IPv4 (0x0800), length 144: 192.168.10.102.51871 > 192.168.10.100.51871: UDP, length 96
# 01:42:43.620165 eth1  In  ifindex 3 08:00:27:6f:81:26 ethertype IPv4 (0x0800), length 464: 192.168.10.102.51871 > 192.168.10.100.51871: UDP, length 416
# 01:42:43.620685 eth1  Out ifindex 3 08:00:27:41:69:da ethertype IPv4 (0x0800), length 144: 192.168.10.100.51871 > 192.168.10.102.51871: UDP, length 96
# 01:42:43.622373 eth1  Out ifindex 3 08:00:27:41:69:da ethertype IPv4 (0x0800), length 144: 192.168.10.100.51871 > 192.168.10.102.51871: UDP, length 96
# 01:42:43.625309 eth1  In  ifindex 3 08:00:27:6f:81:26 ethertype IPv4 (0x0800), length 144: 192.168.10.102.51871 > 192.168.10.100.51871: UDP, length 96
# 01:42:43.627373 eth1  Out ifindex 3 08:00:27:41:69:da ethertype IPv4 (0x0800), length 144: 192.168.10.100.51871 > 192.168.10.102.51871: UDP, length 96

tcpdump -eni any udp port 51871 -w /tmp/wg.pcap 

![Wireshark](/assets/cilium/images/wireshark.png)
```

---

## TLS Interception

### TLS ê°€ë¡œì±„ê¸° ì„¤ì •

**ë‚´ë¶€ CA ìƒì„±**

```bash
# CA ê°œì¸ í‚¤ ìƒì„±
openssl genrsa -des3 -out myCA.key 2048

# CA ì¸ì¦ì„œ ìƒì„±
openssl req -x509 -new -nodes -key myCA.key -sha256 -days 1825 -out myCA.crt

# Country Name (2 letter code) [AU]:KR
# State or Province Name (full name) [Some-State]:Seoul
# Locality Name (eg, city) []:Seoul
# Organization Name (eg, company) [Internet Widgits Pty Ltd]:Chris
# Organizational Unit Name (eg, section) []:None
# Common Name (e.g. server FQDN or YOUR name) []:chris.net 
# Email Address []:
```

**ëŒ€ìƒ ì„œë¹„ìŠ¤ ì¸ì¦ì„œ ìƒì„±**

```bash
# ê°œì¸ í‚¤ ìƒì„±
openssl genrsa -out internal-httpbin.key 2048

# CSR ìƒì„± (Common Name: httpbin.org)
openssl req -new -key internal-httpbin.key -out internal-httpbin.csr

# ì„œëª…ëœ ì¸ì¦ì„œ ìƒì„±
openssl x509 -req -days 360 -in internal-httpbin.csr -CA myCA.crt -CAkey myCA.key \
  -CAcreateserial -out internal-httpbin.crt -sha256

# ì¸ì¦ì„œ í™•ì¸
openssl x509 -in internal-httpbin.crt -noout -text

# Signature Algorithm: sha256WithRSAEncryption
# Issuer: C = KR, ST = Seoul, L = Seoul, O = Chris, OU = None, CN = chris.net
# Validity
#     Not Before: Sep  6 17:08:34 2025 GMT
#     Not After : Sep  1 17:08:34 2026 GMT
# Subject: C = KR, ST = Seoul, L = Seoul, O = Chris, OU = None, CN = httpbin.org

# K8S Secret ìƒì„±
kubectl create secret tls httpbin-tls-data -n kube-system \
  --cert=internal-httpbin.crt --key=internal-httpbin.key

# Ubuntuì˜ ê²½ìš° ë¨¼ì € ì¶”ê°€ CA ì¸ì¦ì„œë¥¼ í´ë¼ì´ì–¸íŠ¸ Pod íŒŒì¼ ì‹œìŠ¤í…œì— ë³µì‚¬í•©ë‹ˆë‹¤.
kubectl cp myCA.crt default/mediabot:/usr/local/share/ca-certificates/myCA.crt
kubectl exec -it mediabot -- ls -l /usr/local/share/ca-certificates/

# /etc/ssl/certs/ca-certificates.crtì— ìˆëŠ” ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ì¸ì¦ ê¸°ê´€ì˜ ê¸€ë¡œë²Œ ì„¸íŠ¸ì— ì´ ì¸ì¦ì„œë¥¼ ì¶”ê°€í•˜ëŠ” Ubuntu ì „ìš© ìœ í‹¸ë¦¬í‹° ì‹¤í–‰
kubectl exec -it mediabot -- ls -l /etc/ssl/certs/ca-certificates.crt # ì‚¬ì´ì¦ˆ, ìƒì„±/ìˆ˜ì • ë‚ ì§œ í™•ì¸
kubectl exec mediabot -- update-ca-certificates

# Updating certificates in /etc/ssl/certs...
# rehash: warning: skipping ca-certificates.crt,it does not contain exactly one certificate or CRL
# 1 added, 0 removed; done.
# Running hooks in /etc/ca-certificates/update.d...
# done.

kubectl exec -it mediabot -- ls -l /etc/ssl/certs/ca-certificates.crt # ì‚¬ì´ì¦ˆ, ìƒì„±/ìˆ˜ì • ë‚ ì§œ í™•ì¸

# Cilium Config ì— ë“¤ì–´ê°ˆ ìì²´ ì„œëª… ì‹ ë¢° ì¸ì¦ì„œ ì œê³µ
kubectl cp default/mediabot:/etc/ssl/certs/ca-certificates.crt ca-certificates.crt

#  ì´ ì¸ì¦ì„œ ë²ˆë“¤ì„ ì‚¬ìš©í•˜ì—¬ Kubernetes ë¹„ë°€ì„ ìƒì„±í•˜ì—¬ Ciliumì´ ì¸ì¦ì„œ ë²ˆë“¤ì„ ì½ê³  ì´ë¥¼ ì‚¬ìš©í•˜ì—¬ ë‚˜ê°€ëŠ” TLS ì—°ê²°ì„ ê²€ì¦í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.
kubectl create secret generic tls-orig-data -n kube-system --from-file=ca.crt=./ca-certificates.crt
kubectl get secret -n kube-system
```

**TLS ì¸ì‹ ì •ì±… ì ìš©**

```bash
# ì •ì±… ì ìš© ì „
kubectl exec -it mediabot -- curl -sL 'https://httpbin.org/headers' -v # ì„œë²„ ì¸ì¦ì„œ í™•ì¸

# * Server certificate:
# *  subject: CN=httpbin.org
# *  start date: Jul 20 00:00:00 2025 GMT
# *  expire date: Aug 17 23:59:59 2026 GMT
# *  subjectAltName: host "httpbin.org" matched cert's "httpbin.org"
# *  issuer: C=US; O=Amazon; CN=Amazon RSA 2048 M03

# ì •ì±… ì ìš©
kubectl create -f https://raw.githubusercontent.com/cilium/cilium/1.18.1/examples/kubernetes-tls-inspection/l7-visibility-tls.yaml
kubectl get cnp

# ì •ì±… ì ìš© í›„
kubectl exec -it mediabot -- curl -sL 'https://httpbin.org/headers' -v # ì„œë²„ ì¸ì¦ì„œ í™•ì¸

# * Server certificate:
# *  subject: C=KR; ST=Seoul; L=Seoul; O=Chris; OU=None; CN=httpbin.org
# *  start date: Sep  6 17:08:34 2025 GMT
# *  expire date: Sep  1 17:08:34 2026 GMT
# *  common name: httpbin.org (matched)
# *  issuer: C=KR; ST=Seoul; L=Seoul; O=Chris; OU=None; CN=chris.net
# *  SSL certificate verify ok.

```

---

## Tetragon: ì‹¤ì‹œê°„ ë³´ì•ˆ ëª¨ë‹ˆí„°ë§

### Tetragon ì„¤ì¹˜

```bash
helm repo add cilium https://helm.cilium.io
helm install tetragon cilium/tetragon -n kube-system
kubectl rollout status -n kube-system ds/tetragon -w

# daemon set "tetragon" successfully rolled out
```

### ì‹¤í–‰ ëª¨ë‹ˆí„°ë§

```bash
# ë°ëª¨ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬
kubectl create -f https://raw.githubusercontent.com/cilium/cilium/v1.18.1/examples/minikube/http-sw-app.yaml

# í™•ì¸
kubectl get pods

# Tetragon Pod í™•ì¸
POD=$(kubectl -n kube-system get pods -l 'app.kubernetes.io/name=tetragon' -o name \
  --field-selector spec.nodeName=$(kubectl get pod xwing -o jsonpath='{.spec.nodeName}'))

# í„°ë¯¸ë„1 - ì‹¤í–‰ ì´ë²¤íŠ¸ ëª¨ë‹ˆí„°ë§
kubectl exec -ti -n kube-system $POD -c tetragon -- tetra getevents -o compact --pods xwing
```

### íŒŒì¼ ì ‘ê·¼ ëª¨ë‹ˆí„°ë§

**ë¯¼ê°í•œ íŒŒì¼ ì ‘ê·¼ì„ ê°ì§€í•˜ëŠ” ì •ì±…**

```bash
# ì½ê¸° ëª¨ë‹ˆí„°ë§ ì ìš©
cat <<EOF | kubectl apply -f -
apiVersion: cilium.io/v1alpha1
kind: TracingPolicy
metadata:
  name: "sensitive-file-monitoring"
spec:
  kprobes:
  - call: "security_file_permission"
    syscall: false
    return: true
    args:
    - index: 0
      type: "file"
    - index: 1
      type: "int"
    returnArg:
      index: 0
      type: "int"
    returnArgAction: "Post"
    selectors:
    - matchArgs:
      - index: 0
        operator: "Prefix"
        values:
        - "/etc/shadow"
        - "/etc/passwd"
        - "/root/.ssh"
        - "/etc/sudoers"
        - "/etc/ssh"
        - "/var/log"
      - index: 1
        operator: "Equal"
        values:
        - "4"  # MAY_READ
EOF

# ë¯¼ê°í•œ íŒŒì¼ ì½ê¸° ì ‘ê·¼
kubectl exec xwing -- cat /etc/hostname
kubectl exec xwing -- cat /etc/passwd

# ğŸš€ process default/xwing /usr/bin/cat /etc/hostname                       
# ğŸ’¥ exit    default/xwing /usr/bin/cat /etc/hostname 0            
# ğŸš€ process default/xwing /usr/bin/cat /etc/passwd                         
# ğŸ“š read    default/xwing /usr/bin/cat /etc/passwd                         
# ğŸ“š read    default/xwing /usr/bin/cat /etc/passwd                         
# ğŸ“š read    default/xwing /usr/bin/cat /etc/passwd                         
# ğŸ“š read    default/xwing /usr/bin/cat /etc/passwd                         
# ğŸ’¥ exit    default/xwing /usr/bin/cat /etc/passwd 0

# ì“°ê¸° ëª¨ë‹ˆí„°ë§ ì ìš©
cat <<EOF | kubectl apply -f -
apiVersion: cilium.io/v1alpha1
kind: TracingPolicy
metadata:
  name: "write-monitoring"
spec:
  kprobes:
  - call: "security_file_permission"
    syscall: false
    return: true
    args:
    - index: 0
      type: "file"
    - index: 1
      type: "int"
    selectors:
    - matchArgs:
      - index: 0
        operator: "Prefix"
        values:
        - "/etc"
        - "/boot"
        - "/usr/bin"
        - "/usr/sbin"
      - index: 1
        operator: "Equal"
        values:
        - "2"  # MAY_WRITE
EOF

# /etc ë””ë ‰í† ë¦¬ì— ì“°ê¸° ì‹œë„
kubectl exec xwing -- sh -c 'echo "test" > /etc/test.txt'
kubectl exec xwing -- sh -c 'echo "test" >> /tmp/test.txt'

# ğŸš€ process default/xwing /usr/bin/sh -c "echo "test" > /etc/test.txt"     
# ğŸ’¥ exit    default/xwing /usr/bin/sh -c "echo "test" > /etc/test.txt" 0 
# ğŸš€ process default/xwing /usr/bin/sh -c "echo "test" >> /tmp/test.txt"    
# ğŸ’¥ exit    default/xwing /usr/bin/sh -c "echo "test" >> /tmp/test.txt" 0 
```

---
